generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  password      String
  pendingConfig Json?          // Store config before payment
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  subscription  Subscription?
  instance      Instance?

  @@map("users")
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeCustomerId      String   @unique
  stripeSubscriptionId  String   @unique
  stripePriceId         String
  stripeCurrentPeriodEnd DateTime

  plan                  Plan
  status                SubscriptionStatus

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("subscriptions")
}

enum Plan {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  INCOMPLETE
  TRIALING
  UNPAID
}

model Instance {
  id            String          @id @default(cuid())
  userId        String          @unique
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  containerId   String?         @unique
  containerName String          @unique
  port          Int             @unique
  status        InstanceStatus

  accessUrl     String?
  serviceUrl    String?         // Internal service URL for API calls
  qrCode        String?

  deployBackend   String        @default("railway") // "railway" | "docker"
  configVersion   Int           @default(1)
  lastConfigApply DateTime?

  config        Configuration?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lastHealthCheck DateTime?

  @@map("instances")
}

enum InstanceStatus {
  DEPLOYING
  RUNNING
  STOPPED
  ERROR
  RESTARTING
}

model Configuration {
  id          String   @id @default(cuid())
  instanceId  String   @unique
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // AI Provider
  provider    AIProvider
  apiKey      String     @db.Text
  model       String

  // Channels
  channels    Channel[]

  // Skills & Extensions
  webSearchEnabled    Boolean @default(false)
  braveApiKey         String?
  browserEnabled      Boolean @default(false)
  ttsEnabled          Boolean @default(false)
  elevenlabsApiKey    String?
  canvasEnabled       Boolean @default(false)
  cronEnabled         Boolean @default(false)
  memoryEnabled       Boolean @default(false)

  // Advanced Settings
  workspace           String?
  agentName           String?
  systemPrompt        String? @db.Text
  thinkingMode        String  @default("high")
  sessionMode         String  @default("per-sender")
  dmPolicy            String  @default("pairing")
  gatewayToken        String?

  // Full OpenClaw config JSON
  fullConfig          Json

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("configurations")
}

enum AIProvider {
  ANTHROPIC
  OPENAI
  GOOGLE
  XAI
  GROQ
  MISTRAL
  DEEPSEEK
  CEREBRAS
  VENICE
  MOONSHOT
  MINIMAX
  TOGETHER
  NVIDIA
  HUGGINGFACE
  OPENROUTER
}

model Channel {
  id              String        @id @default(cuid())
  configId        String
  configuration   Configuration @relation(fields: [configId], references: [id], onDelete: Cascade)

  type            ChannelType
  enabled         Boolean       @default(true)

  // Channel-specific config (JSON)
  config          Json

  // Access info
  botUsername     String?
  phoneNumber     String?
  inviteLink      String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("channels")
}

enum ChannelType {
  WHATSAPP
  TELEGRAM
  DISCORD
  SLACK
  SIGNAL
  GOOGLE_CHAT
  IMESSAGE
  MATRIX
  MSTEAMS
}

model DeploymentLog {
  id          String   @id @default(cuid())
  instanceId  String
  action      String
  status      String
  message     String?  @db.Text
  error       String?  @db.Text

  createdAt   DateTime @default(now())

  @@map("deployment_logs")
}

model ConfigChangeLog {
  id          String   @id @default(cuid())
  instanceId  String
  field       String
  action      String   // "update", "add", "remove"
  status      String   @default("pending") // pending | applied | failed
  createdAt   DateTime @default(now())

  @@map("config_change_logs")
}
